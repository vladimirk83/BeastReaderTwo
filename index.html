let fechaTransaccion = '';

$(document).ready(function() {

    // Define la URL de tu API de SheetDB  
    const SHEETDB_API_URL = 'https://sheetdb.io/api/v1/gect4lbs5bwvr'; // Reemplaza con tu URL real

    // Inicializar Flatpickr con selección de rango de fechas
// Inicializar Flatpickr con selección de rango de fechas
flatpickr("#fecha", {
    mode: "multiple",
    dateFormat: "m-d-Y", // Cambiado a MM-DD-YYYY
    minDate: "today",
    maxDate: null,
    defaultDate: null,
    allowInput: true,
    onChange: function(selectedDates, dateStr, instance) {
        selectedDays = selectedDates.length;
        console.log("Días seleccionados:", selectedDays);
        calcularTotal();
    },
});

    let jugadaCount = 0;
    let selectedTracks = 0;
    let selectedDays = 0;

    // Horarios de cierre por track
    const horariosCierre = {
        "USA": {
            "New York Mid Day": "14:25",
            "New York Evening": "22:25",
            "Georgia Mid Day": "12:20",
            "Georgia Evening": "18:45",
            "New Jersey Mid Day": "12:54",
            "New Jersey Evening": "22:50",
            "Florida Mid Day": "13:25",
            "Florida Evening": "21:30",
            "Connecticut Mid Day": "13:35",
            "Connecticut Evening": "22:20",
            "Georgia Night": "23:20",
            "Pensilvania AM": "12:55",
            "Pensilvania PM": "18:20"
            // Nota: "Venezuela" se excluye aquí
        },
        "Santo Domingo": {
            "Real": "12:45",
            "Gana mas": "14:25",
            "Loteka": "19:30",
            "Nacional": "20:30", // Domingos a las 17:50
            "Quiniela Pale": "20:30", // Domingos a las 15:30
            "Primera Día": "11:50",
            "Suerte Día": "12:20",
            "Lotería Real": "12:50",
            "Suerte Tarde": "17:50",
            "Lotedom": "17:50",
            "Primera Noche": "19:50",
            "Panama": "16:00",
            // Horarios especiales para domingos
            "Quiniela Pale Domingo": "15:30",
            "Nacional Domingo": "17:50"
        },
        "Venezuela": {
            "Venezuela": "19:00" // Asumiendo un horario de cierre para Venezuela
        }
    };

    // Límites de apuestas por modalidad
    const limitesApuesta = {
    "Win 4": { "straight": 6, "box": 30, "combo": 50 },
    "Peak 3": { "straight": 35, "box": 50, "combo": 70 },
    "Venezuela": { "straight": 100 },
    "Venezuela-Pale": { "straight": 100 },
    "Pulito": { "straight": 100 },
    "RD-Quiniela": { "straight": 100 }, // Actualizado a $100
    "RD-Pale": { "straight": 20 }, // Se mantiene en $20
    "Combo": { "combo": 50 } // Añadido
};
    // Modalidades de juego
    function determinarModalidad(tracks, numero, fila) {
        let modalidad = "-";

        const esUSA = tracks.some(track => Object.keys(horariosCierre["USA"]).includes(track));
        const esSD = tracks.some(track => Object.keys(horariosCierre["Santo Domingo"]).includes(track));
        const incluyeVenezuela = tracks.includes("Venezuela");

        const longitud = numero.length;
        const boxValue = parseInt(fila.find(".box").val()) || 0;

        if (incluyeVenezuela && esUSA && longitud === 2) {
            modalidad = "Venezuela";
        } else if (esUSA && !esSD) {
            if (longitud === 4) {
                modalidad = "Win 4";
            } else if (longitud === 3) {
                modalidad = "Peak 3";
            } else if (longitud === 2 && [1, 2, 3].includes(boxValue)) {
                modalidad = "Pulito";
            }
        } else if (esSD && !esUSA) {
            if (longitud === 2) {
                modalidad = "RD-Quiniela";
            } else if (longitud === 4) {
                modalidad = "RD-Pale";
            }
        }

        return modalidad;
    }

    // Función para agregar una nueva jugada
    function agregarJugada() {
        if (jugadaCount >= 100) {
            alert("Has alcanzado el máximo de 100 jugadas.");
            return;
        }
        jugadaCount++;
        const fila = 
            <tr>
                <td>${jugadaCount}</td>
                <td><input type="number" class="form-control numeroApostado" min="0" max="9999" required></td>
                <td class="tipoJuego">-</td>
                <td><input type="number" class="form-control straight" min="0" max="100.00" step="1" placeholder="Ej: 5"></td>
                <td><input type="number" class="form-control box" min="1" max="3" step="1" placeholder="1, 2 o 3"></td>
                <td><input type="number" class="form-control combo" min="0" max="50.00" step="0.10" placeholder="Ej: 3.00"></td>
                <td class="total">0.00</td>
            </tr>
        ;
        $("#tablaJugadas").append(fila);
    }

    // Agregar una jugada inicial
    agregarJugada();

    // Evento para agregar más jugadas
    $("#agregarJugada").click(function() {
        agregarJugada();
    });

    // Evento para eliminar la última jugada
    $("#eliminarJugada").click(function() {
        if (jugadaCount === 0) {
            alert("No hay jugadas para eliminar.");
            return;
        }
        // Remover la última fila
        $("#tablaJugadas tr:last").remove();
        jugadaCount--;
        // Actualizar el número de jugadas
        $("#tablaJugadas tr").each(function(index) {
            $(this).find("td:first").text(index + 1);
        });
        calcularTotal();
    });

    // Contador de tracks seleccionados y días
$(".track-checkbox").change(function() {
    const tracksSeleccionados = $(".track-checkbox:checked").map(function() { return $(this).val(); }).get();
    // Excluir "Venezuela" del conteo de tracks para el cálculo del total
    selectedTracks = tracksSeleccionados.filter(track => track !== "Venezuela").length || 1;

    calcularTotal();
});


 // $("#fecha").change(function() {
//     const fechas = $(this).val();
//     if (fechas) {
//         const fechasArray = fechas.split(", ");
//         selectedDays = fechasArray.length;
//     } else {
//         selectedDays = 0;
//     }
//     calcularTotal();
// });


    // Función para calcular la diferencia de días entre dos fechas
    function calcularDiferenciaDias(fechaInicio, fechaFin) {
        const inicio = new Date(fechaInicio);
        const fin = new Date(fechaFin);
        const diferencia = fin - inicio;
        return Math.floor(diferencia / (1000 * 60 * 60 * 24));
    }

    // Evento para detectar cambios en los campos de entrada
    $("#tablaJugadas").on("input", ".numeroApostado, .straight, .box, .combo", function() {
        const fila = $(this).closest("tr");
        const num = fila.find(".numeroApostado").val();
        const tracks = $(".track-checkbox:checked").map(function() { return $(this).val(); }).get();
        const modalidad = determinarModalidad(tracks, num, fila);
        fila.find(".tipoJuego").text(modalidad);
        actualizarPlaceholders(modalidad, fila);
        calcularTotalJugada(fila);
        calcularTotal();
    });

    // Función para actualizar los placeholders según la modalidad
    function actualizarPlaceholders(modalidad, fila) {
    if (limitesApuesta[modalidad]) {
        fila.find(".straight").attr("placeholder", Máximo $${limitesApuesta[modalidad].straight}).prop('disabled', false);
    } else {
        fila.find(".straight").attr("placeholder", "Ej: 5.00").prop('disabled', false);
    }

    if (modalidad === "Pulito") {
        fila.find(".box").attr("placeholder", "1, 2 o 3").prop('disabled', false);
        fila.find(".combo").attr("placeholder", "No aplica").prop('disabled', true).val('');
    } else if (modalidad === "Venezuela" || modalidad.startsWith("RD-")) {
        fila.find(".box").attr("placeholder", "No aplica").prop('disabled', true).val('');
        fila.find(".combo").attr("placeholder", "No aplica").prop('disabled', true).val('');
    } else if (modalidad === "Win 4" || modalidad === "Peak 3") {
        fila.find(".box").attr("placeholder", Máximo $${limitesApuesta[modalidad].box}).prop('disabled', false);
        fila.find(".combo").attr("placeholder", Máximo $${limitesApuesta[modalidad].combo}).prop('disabled', false);
    } else if (modalidad === "Combo") { // Añadido
        fila.find(".straight").attr("placeholder", "No aplica").prop('disabled', true).val('');
        fila.find(".box").attr("placeholder", "No aplica").prop('disabled', true).val('');
        fila.find(".combo").attr("placeholder", Máximo $${limitesApuesta["Combo"].combo}).prop('disabled', false);
    } else {
        // Modalidad no reconocida
        fila.find(".box").attr("placeholder", "Ej: 2.50").prop('disabled', false);
        fila.find(".combo").attr("placeholder", "Ej: 3.00").prop('disabled', false);
    }
}
    // Función para calcular el total de una jugada
    function calcularTotalJugada(fila) {
    const modalidad = fila.find(".tipoJuego").text();
    const numero = fila.find(".numeroApostado").val();
    if (!numero || numero.length < 2 || numero.length > 4) {
        fila.find(".total").text("0.00");
        return;
    }

    const combinaciones = calcularCombinaciones(numero);
    let straight = parseFloat(fila.find(".straight").val()) || 0;
    let box = parseFloat(fila.find(".box").val()) || 0;
    let combo = parseFloat(fila.find(".combo").val()) || 0;

    // Aplicar límites según modalidad
    if (limitesApuesta[modalidad]) {
        straight = Math.min(straight, limitesApuesta[modalidad].straight || straight);
        if (limitesApuesta[modalidad].box !== undefined && modalidad !== "Pulito") {
            box = Math.min(box, limitesApuesta[modalidad].box || box);
        }
        if (limitesApuesta[modalidad].combo !== undefined) {
            combo = Math.min(combo, limitesApuesta[modalidad].combo || combo);
        }
    }

    // Calcular total según modalidad
    let total = 0;
    if (modalidad === "Pulito") {
        total = straight; // No sumar box
    } else if (modalidad === "Venezuela" || modalidad.startsWith("RD-")) {
        total = straight;
    } else if (modalidad === "Win 4" || modalidad === "Peak 3") {
        total = straight + box + (combo * combinaciones);
    } else if (modalidad === "Combo") { // Añadido
        total = combo; // Solo sumar combo
    } else {
        // Modalidad no reconocida
        total = straight + box + combo;
    }

    fila.find(".total").text(total.toFixed(2));
}
    // Función para calcular el número de combinaciones posibles
    function calcularCombinaciones(numero) {
        const counts = {};
        for (let char of numero) {
            counts[char] = (counts[char] || 0) + 1;
        }
        let factorial = (n) => n <= 1 ? 1 : n * factorial(n - 1);
        let totalDigits = numero.length;
        let denominator = 1;
        for (let digit in counts) {
            denominator *= factorial(counts[digit]);
        }
        return factorial(totalDigits) / denominator;
    }

    // Función para calcular el total de todas las jugadas
    function calcularTotal() {
    let total = 0;
    $(".total").each(function() {
        total += parseFloat($(this).text()) || 0;
    });
    console.log("Total de jugadas antes de multiplicar:", total);
    console.log("Tracks seleccionados:", selectedTracks);
    console.log("Días seleccionados:", selectedDays);

    // Si no hay días seleccionados, el total es 0
    if (selectedDays === 0) {
        total = 0;
    } else {
        // Multiplicar por el número de tracks seleccionados y días
        total = (total * selectedTracks * selectedDays).toFixed(2);
    }
    console.log("Total después de multiplicar:", total);
    $("#totalJugadas").text(total);
}


    // Inicializar Bootstrap Modal
    var ticketModal = new bootstrap.Modal(document.getElementById('ticketModal'));

    // Función para obtener la hora límite de un track
    function obtenerHoraLimite(track) {
        for (let region in horariosCierre) {
            if (horariosCierre[region][track]) {
                return horariosCierre[region][track];
            }
        }
        return null;
    }

    // Evento para generar el ticket
    $("#generarTicket").click(function() {
        // Validar formulario
        const fecha = $("#fecha").val();
        console.log("Valor de fecha:", fecha);
        if (!fecha) {
            alert("Por favor, selecciona una fecha.");
            return;
        }
        const tracks = $(".track-checkbox:checked").map(function() { return $(this).val(); }).get();
        if (!tracks || tracks.length === 0) {
            alert("Por favor, selecciona al menos un track.");
            return;
        }

        // Validar que si se seleccionó el track "Venezuela", se haya seleccionado al menos un track de USA
        const tracksUSASeleccionados = tracks.filter(track => Object.keys(horariosCierre["USA"]).includes(track));
        if (tracks.includes("Venezuela") && tracksUSASeleccionados.length === 0) {
            alert("Para jugar en la modalidad 'Venezuela', debes seleccionar al menos un track de USA además de 'Venezuela'.");
            return;
        }

        // Obtener las fechas seleccionadas como array
const fechasArray = fecha.split(", ");
const fechaActual = new Date();
const yearActual = fechaActual.getFullYear();
const monthActual = fechaActual.getMonth();
const dayActual = fechaActual.getDate();
const fechaActualSinHora = new Date(yearActual, monthActual, dayActual);

// Validar cada fecha seleccionada
for (let fechaSeleccionadaStr of fechasArray) {
    // Extraer los componentes de la fecha seleccionada
    const [monthSel, daySel, yearSel] = fechaSeleccionadaStr.split('-').map(Number);
    const fechaSeleccionada = new Date(yearSel, monthSel - 1, daySel);

    if (fechaSeleccionada.getTime() === fechaActualSinHora.getTime()) {
        // La fecha seleccionada es hoy, aplicar validación de hora
        const horaActual = new Date();
        for (let track of tracks) {
            if (track === 'Venezuela') continue; // Excluir "Venezuela" de la validación de hora
            
            const horaLimiteStr = obtenerHoraLimite(track);
            if (horaLimiteStr) {
                const horaLimite = new Date();
                const [horas, minutos] = horaLimiteStr.split(":");
                horaLimite.setHours(parseInt(horas), parseInt(minutos) - 5, 0, 0); // Restamos 5 minutos
                if (horaActual > horaLimite) {
                    alert(El track "${track}" ya ha cerrado para hoy. Por favor, selecciona otro track o fecha.);
                    return;
                }
            }
        }
    }
    
}

// Si la fecha seleccionada es futura, no se aplica la validación de hora
 
        // Validar jugadas
        let jugadasValidas = true;
        $("#tablaJugadas tr").each(function() {
            const numero = $(this).find(".numeroApostado").val();
            const modalidad = $(this).find(".tipoJuego").text();
            if (!numero || (numero.length < 2 || numero.length > 4)) {
                jugadasValidas = false;
                alert("Por favor, ingresa números apostados válidos (2, 3 o 4 dígitos).");
                return false;
            }
            if (modalidad === "-" ) {
                jugadasValidas = false;
                alert("Por favor, selecciona una modalidad de juego válida.");
                return false;              
            }

            // Nueva Validación: Verificar que la jugada tiene al menos un track seleccionado correspondiente a su modalidad
    let tracksRequeridos = [];

    if (["Win 4", "Peak 3", "Pulito", "Venezuela"].includes(modalidad)) {
        // Modalidades que requieren tracks de USA
        tracksRequeridos = Object.keys(horariosCierre["USA"]);
    } else if (["RD-Quiniela", "RD-Pale"].includes(modalidad)) {
        // Modalidades que requieren tracks de Santo Domingo
        tracksRequeridos = Object.keys(horariosCierre["Santo Domingo"]);
    } else {
        // Modalidad no reconocida o no requiere validación específica
        tracksRequeridos = [];
    }

    // Verificar si al menos uno de los tracks requeridos está seleccionado
    const tracksSeleccionadosParaModalidad = tracks.filter(track => tracksRequeridos.includes(track));

    if (tracksRequeridos.length > 0 && tracksSeleccionadosParaModalidad.length === 0) {
        jugadasValidas = false;
        alert(La jugada con modalidad "${modalidad}" requiere al menos un track seleccionado correspondiente.);
        return false; // Salir del bucle
    }

            if (["Venezuela", "Venezuela-Pale", "Pulito", "RD-Quiniela", "RD-Pale"].includes(modalidad)) {
                const straight = parseFloat($(this).find(".straight").val()) || 0;
                if (straight <= 0) {
                    jugadasValidas = false;
                    alert("Por favor, ingresa al menos una apuesta en Straight.");
                    return false;
                }
                if (modalidad === "Pulito") {
                    const box = parseInt($(this).find(".box").val());
                    if (![1, 2, 3].includes(box)) {
                        jugadasValidas = false;
                        alert("En la modalidad Pulito, el campo 'Box' debe ser 1, 2 o 3.");
                        return false;
                    }
                }
            } else if (["Win 4", "Peak 3"].includes(modalidad)) {
                const straight = parseFloat($(this).find(".straight").val()) || 0;
                const box = parseFloat($(this).find(".box").val()) || 0;
                const combo = parseFloat($(this).find(".combo").val()) || 0;
                if (straight <= 0 && box <= 0 && combo <= 0) {
                    jugadasValidas = false;
                    alert(Por favor, ingresa al menos una apuesta en Straight, Box o Combo para ${modalidad}.);
                    return false;
                }
            }           
            // Validar límites
            if (limitesApuesta[modalidad]) {
                if (parseFloat($(this).find(".straight").val()) > (limitesApuesta[modalidad].straight || Infinity)) {
                    jugadasValidas = false;
                    alert(El monto en Straight excede el límite para ${modalidad}.);
                    return false;
                }
                if (limitesApuesta[modalidad].box !== undefined && modalidad !== "Pulito" && parseFloat($(this).find(".box").val()) > (limitesApuesta[modalidad].box || Infinity)) {
                    jugadasValidas = false;
                    alert(El monto en Box excede el límite para ${modalidad}.);
                    return false;
                }
                if (limitesApuesta[modalidad].combo !== undefined && parseFloat($(this).find(".combo").val()) > (limitesApuesta[modalidad].combo || Infinity)) {
                    jugadasValidas = false;
                    alert(El monto en Combo excede el límite para ${modalidad}.);
                    return false;
                }
            }
        });
        if (!jugadasValidas) {
            return;
        }

        // Preparar datos para el ticket
        const tracksTexto = tracks.join(", ");
        $("#ticketTracks").text(tracksTexto);
        $("#ticketJugadas").empty();
        $("#tablaJugadas tr").each(function() {
            const num = $(this).find(".numeroApostado").val();
            const modalidad = $(this).find(".tipoJuego").text();
            const straight = parseFloat($(this).find(".straight").val()) || 0;
            const boxVal = $(this).find(".box").val();
            const box = boxVal !== "" ? boxVal : "-";
            const comboVal = $(this).find(".combo").val();
            const combo = comboVal !== "" ? parseFloat(comboVal) : "-";
            const total = parseFloat($(this).find(".total").text()) || 0;
            const fila = 
                <tr>
                    <td>${$(this).find("td").first().text()}</td>
                    <td>${num}</td>
                    <td>${modalidad}</td>
                    <td>${straight.toFixed(2)}</td>
                    <td>${box !== "-" ? box : "-"}</td>
                    <td>${combo !== "-" ? combo.toFixed(2) : "-"}</td>
                    <td>${total.toFixed(2)}</td>
                </tr>
            ;
            $("#ticketJugadas").append(fila);
        });
        $("#ticketTotal").text($("#totalJugadas").text());
        // Generar número de ticket único de 8 dígitos
const numeroTicket = generarNumeroUnico();
$("#numeroTicket").text(numeroTicket);

// Generar la fecha y hora de transacción
fechaTransaccion = dayjs().format('MM-DD-YYYY hh:mm A');
$("#ticketTransaccion").text(fechaTransaccion);


// Generar código QR
$("#qrcode").empty(); // Limpiar el contenedor anterior
new QRCode(document.getElementById("qrcode"), {
    text: numeroTicket,
    width: 128,
    height: 128,
});

// Mostrar las fechas de apuesta en el ticket
$("#ticketFecha").text(${fecha});
console.log("Fechas asignadas a #ticketFecha:", $("#ticketFecha").text());        
        // Mostrar el modal usando Bootstrap 5
        ticketModal.show();
    });

    // Función para generar número único de ticket de 8 dígitos
    function generarNumeroUnico() {
        return Math.floor(10000000 + Math.random() * 90000000).toString();
    }

    // Evento para confirmar e imprimir el ticket
    // Evento para confirmar e imprimir el ticket
$("#confirmarTicket").click(function() {
    // Datos comunes a todas las jugadas
    const ticketNumber = $("#numeroTicket").text();
    const transactionDateTime = fechaTransaccion;
    const betDates = $("#ticketFecha").text();
    const tracks = $("#ticketTracks").text();
    const totalTicket = $("#ticketTotal").text();
    const timestamp = new Date().toISOString();

    // Array para almacenar las jugadas
    const jugadasData = [];

    // Recorrer cada jugada y preparar los datos
    $("#ticketJugadas tr").each(function() {
        // Generar número único de 8 dígitos para la jugada
        const jugadaNumber = generarNumeroUnico();

        const jugadaData = {
            "Ticket Number": ticketNumber,
            "Transaction DateTime": transactionDateTime,
            "Bet Dates": betDates,
            "Tracks": tracks,
            "Bet Number": $(this).find("td").eq(1).text(),
            "Game Mode": $(this).find("td").eq(2).text(),
            "Straight ($)": $(this).find("td").eq(3).text(),
            "Box ($)": $(this).find("td").eq(4).text() !== "-" ? $(this).find("td").eq(4).text() : "",
            "Combo ($)": $(this).find("td").eq(5).text() !== "-" ? $(this).find("td").eq(5).text() : "",
            "Total ($)": $(this).find("td").eq(6).text(),
            "Jugada Number": jugadaNumber,
            "Timestamp": timestamp
        };

        // Añadir la jugada al array
        jugadasData.push(jugadaData);
    });

    // Enviar datos a SheetDB
    $.ajax({
        url: SHEETDB_API_URL, // Usar la variable de SheetDB
        method: "POST",
        dataType: "json",
        contentType: "application/json",
        data: JSON.stringify(jugadasData),
        success: function(response) {
            // Imprimir el ticket
            window.print();

            // Opcional: Usar html2canvas para capturar solo el ticket
  html2canvas(document.querySelector("#preTicket")).then(canvas => {
    // Obtener la imagen en formato data URL
    const imgData = canvas.toDataURL("image/png");
    // Crear un enlace para descargar la imagen
    const link = document.createElement('a');
    link.href = imgData;
    link.download = 'ticket.png';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });
            // Cerrar el modal
            ticketModal.hide();
            // Reiniciar el formulario
            resetForm();
            alert("Ticket guardado y enviado exitosamente.");
        },
        error: function(err) {
            console.error("Error al enviar datos a SheetDB:", err);
            // Mostrar mensaje de error más detallado
            alert("Hubo un problema al enviar los datos. Por favor, inténtalo de nuevo.\nDetalles del error: " + JSON.stringify(err));
        }
    });
});

    // Función para reiniciar el formulario
    function resetForm() {
        $("#lotteryForm")[0].reset();
        $("#tablaJugadas").empty();
        jugadaCount = 0;
        selectedTracks = 0;
        selectedDays = 0;
        agregarJugada();
        $("#totalJugadas").text("0.00");
        // Resetear los placeholders
        $("#tablaJugadas tr").each(function() {
            actualizarPlaceholders("-", $(this));
        });
    }

    // Calcular y mostrar las horas límite junto a cada track
    function mostrarHorasLimite() {
        $(".cutoff-time").each(function() {
            const track = $(this).data("track");
            let cierreStr = "";
            if (horariosCierre["USA"][track]) {
                cierreStr = horariosCierre["USA"][track];
            } else if (horariosCierre["Santo Domingo"][track]) {
                cierreStr = horariosCierre["Santo Domingo"][track];
            } else if (horariosCierre["Venezuela"][track]) {
                cierreStr = horariosCierre["Venezuela"][track];
            }
            if (cierreStr) {
                const cierre = new Date(1970-01-01T${cierreStr}:00);
                cierre.setMinutes(cierre.getMinutes() - 5); // 5 minutos antes
                const horas = cierre.getHours().toString().padStart(2, '0');
                const minutos = cierre.getMinutes().toString().padStart(2, '0');
                const horaLimite = ${horas}:${minutos};
                $(this).text(Hora límite: ${horaLimite});
            }
        });
       }

// Función para resaltar números duplicados
function resaltarDuplicados() {
    // Obtener todos los campos de número apostado
    const camposNumeros = document.querySelectorAll('.numeroApostado');
    const valores = {};
    const duplicados = new Set();

    // Recopilar valores y detectar duplicados
    camposNumeros.forEach(campo => {
        const valor = campo.value.trim();
        if (valor) {
            if (valores[valor]) {
                duplicados.add(valor);
            } else {
                valores[valor] = true;
            }
        }
    });

    // Aplicar o remover la clase .duplicado
    camposNumeros.forEach(campo => {
        if (duplicados.has(campo.value.trim())) {
            campo.classList.add('duplicado');
        } else {
            campo.classList.remove('duplicado');
        }
    });
}

// Función para agregar listeners a los campos de número apostado
function agregarListenersNumeroApostado() {
    const camposNumeros = document.querySelectorAll('.numeroApostado');
    camposNumeros.forEach(campo => {
        campo.removeEventListener('input', resaltarDuplicados); // Evitar duplicar listeners
        campo.addEventListener('input', resaltarDuplicados);
    });
}

// Agregar listeners al cargar la página
document.addEventListener('DOMContentLoaded', () => {
    agregarListenersNumeroApostado();
    resaltarDuplicados(); // Resaltar duplicados al cargar, si los hay

    // Agregar listener al botón de agregar jugada
    const btnAgregarJugada = document.getElementById('agregarJugada');
    btnAgregarJugada.addEventListener('click', () => {
        setTimeout(() => {
            agregarListenersNumeroApostado();
            resaltarDuplicados();
        }, 100); // Esperar a que se agregue la nueva jugada
    });
});    
    // Llamar a la función para mostrar las horas límite al cargar la página
    mostrarHorasLimite();


CODIGO HTML: 


<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Beast Reader (Cricket) East New York</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Flatpickr CSS -->
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
    <!-- Bootstrap Icons (Opcional) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <div class="container my-5">
        <h2 class="text-center mb-4"> Beast Reader (Cricket) East New York </h2>
        <form id="lotteryForm">
            <!-- Selección de Fecha y Hora -->
            <div class="row mb-3">
                <div class="col-md-4 col-sm-6">
                    <label for="fecha" class="form-label">Fechas de Apuesta:</label>
                    <input type="text" id="fecha" class="form-control glow-input" placeholder="Selecciona fecha" required>
                </div>
            </div>
            <!-- Selección de Tracks -->
            <div class="mb-4">
                <label class="form-label">Selecciona los Tracks:</label>
                <div class="accordion" id="tracksAccordion">
                    <!-- USA Tracks -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingUSA">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUSA" aria-expanded="false" aria-controls="collapseUSA">
                                USA
                            </button>
                        </h2>
                        <div id="collapseUSA" class="accordion-collapse collapse" aria-labelledby="headingUSA" data-bs-parent="#tracksAccordion">
                            <div class="accordion-body">
                                <!-- Agrega aquí todos los tracks de USA -->
                                <!-- New York Mid Day -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="New York Mid Day" id="trackNYMidDay">
                                        <label class="form-check-label" for="trackNYMidDay">New York Mid Day</label>
                                    </div>
                                    <span class="cutoff-time" data-track="New York Mid Day">14:25</span>
                                </div>
                                <!-- New York Evening -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="New York Evening" id="trackNYEvening">
                                        <label class="form-check-label" for="trackNYEvening">New York Evening</label>
                                    </div>
                                    <span class="cutoff-time" data-track="New York Evening">22:25</span>
                                </div>
                                <!-- Georgia Mid Day -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Georgia Mid Day" id="trackGeorgiaMidDay">
                                        <label class="form-check-label" for="trackGeorgiaMidDay">Georgia Mid Day</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Georgia Mid Day">12:20</span>
                                </div>
                                <!-- Georgia Evening -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Georgia Evening" id="trackGeorgiaEvening">
                                        <label class="form-check-label" for="trackGeorgiaEvening">Georgia Evening</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Georgia Evening">18:45</span>
                                </div>
                                <!-- New Jersey Mid Day -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="New Jersey Mid Day" id="trackNJMidDay">
                                        <label class="form-check-label" for="trackNJMidDay">New Jersey Mid Day</label>
                                    </div>
                                    <span class="cutoff-time" data-track="New Jersey Mid Day">12:54</span>
                                </div>
                                <!-- New Jersey Evening -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="New Jersey Evening" id="trackNJEvening">
                                        <label class="form-check-label" for="trackNJEvening">New Jersey Evening</label>
                                    </div>
                                    <span class="cutoff-time" data-track="New Jersey Evening">22:50</span>
                                </div>
                                <!-- Florida Mid Day -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Florida Mid Day" id="trackFloridaMidDay">
                                        <label class="form-check-label" for="trackFloridaMidDay">Florida Mid Day</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Florida Mid Day">13:25</span>
                                </div>
                                <!-- Florida Evening -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Florida Evening" id="trackFloridaEvening">
                                        <label class="form-check-label" for="trackFloridaEvening">Florida Evening</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Florida Evening">21:30</span>
                                </div>
                                <!-- Connecticut Mid Day -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Connecticut Mid Day" id="trackConnecticutMidDay">
                                        <label class="form-check-label" for="trackConnecticutMidDay">Connecticut Mid Day</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Connecticut Mid Day">13:35</span>
                                </div>
                                <!-- Connecticut Evening -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Connecticut Evening" id="trackConnecticutEvening">
                                        <label class="form-check-label" for="trackConnecticutEvening">Connecticut Evening</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Connecticut Evening">22:20</span>
                                </div>
                                <!-- Georgia Night -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Georgia Night" id="trackGeorgiaNight">
                                        <label class="form-check-label" for="trackGeorgiaNight">Georgia Night</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Georgia Night">23:20</span>
                                </div>
                                <!-- Pensilvania AM -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Pensilvania AM" id="trackPennsylvaniaAM">
                                        <label class="form-check-label" for="trackPennsylvaniaAM">Pensilvania AM</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Pensilvania AM">12:55</span>
                                </div>
                                <!-- Pensilvania PM -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Pensilvania PM" id="trackPennsylvaniaPM">
                                        <label class="form-check-label" for="trackPennsylvaniaPM">Pensilvania PM</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Pensilvania PM">18:20</span>
                                </div>
                                <!-- Venezuela -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Venezuela" id="trackVenezuela">
                                        <label class="form-check-label" for="trackVenezuela">Venezuela</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Venezuela">19:00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Santo Domingo Tracks -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingSD">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSD" aria-expanded="false" aria-controls="collapseSD">
                                Santo Domingo
                            </button>
                        </h2>
                        <div id="collapseSD" class="accordion-collapse collapse" aria-labelledby="headingSD" data-bs-parent="#tracksAccordion">
                            <div class="accordion-body">
                                <!-- Agrega aquí todos los tracks de Santo Domingo -->
                                <!-- Real -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Real" id="trackReal">
                                        <label class="form-check-label" for="trackReal">Real</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Real">12:45</span>
                                </div>
                                <!-- Gana mas -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Gana mas" id="trackGanamas">
                                        <label class="form-check-label" for="trackGanamas">Gana más</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Gana mas">14:25</span>
                                </div>
                                <!-- Loteka -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Loteka" id="trackLoteka">
                                        <label class="form-check-label" for="trackLoteka">Loteka</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Loteka">19:30</span>
                                </div>
                                <!-- Nacional -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Nacional" id="trackNacional">
                                        <label class="form-check-label" for="trackNacional">Nacional</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Nacional">20:30</span>
                                </div>
                                <!-- Quiniela Pale -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Quiniela Pale" id="trackQuinielaPale">
                                        <label class="form-check-label" for="trackQuinielaPale">Quiniela Pale</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Quiniela Pale">20:30</span>
                                </div>
                                <!-- Primera Día -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Primera Día" id="trackPrimeraDia">
                                        <label class="form-check-label" for="trackPrimeraDia">Primera Día</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Primera Día">11:50</span>
                                </div>
                                <!-- Suerte Día -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Suerte Día" id="trackSuerteDia">
                                        <label class="form-check-label" for="trackSuerteDia">Suerte Día</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Suerte Día">12:20</span>
                                </div>
                                <!-- Lotería Real -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Lotería Real" id="trackLoteriaReal">
                                        <label class="form-check-label" for="trackLoteriaReal">Lotería Real</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Lotería Real">12:50</span>
                                </div>
                                <!-- Suerte Tarde -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Suerte Tarde" id="trackSuerteTarde">
                                        <label class="form-check-label" for="trackSuerteTarde">Suerte Tarde</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Suerte Tarde">17:50</span>
                                </div>
                                <!-- Lotedom -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Lotedom" id="trackLotedom">
                                        <label class="form-check-label" for="trackLotedom">Lotedom</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Lotedom">17:50</span>
                                </div>
                                <!-- Primera Noche -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Primera Noche" id="trackPrimeraNoche">
                                        <label class="form-check-label" for="trackPrimeraNoche">Primera Noche</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Primera Noche">19:50</span>
                                </div>
                                <!-- Panamá -->
                                <div class="form-check d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input class="form-check-input track-checkbox" type="checkbox" value="Panama" id="trackPanama">
                                        <label class="form-check-label" for="trackPanama">Panamá</label>
                                    </div>
                                    <span class="cutoff-time" data-track="Panama">16:00</span>
                                </div>
                                <!-- Agrega otros tracks si es necesario -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Tabla de Jugadas -->
            <div class="table-responsive mb-4">
                <table class="table table-dark table-bordered glow-table" id="jugadasTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Número Apostado</th>
                            <th>Tipo de Juego</th>
                            <th>Straight ($)</th>
                            <th>Box ($)</th>
                            <th>Combo ($)</th>
                            <th>Total ($)</th>
                        </tr>
                    </thead>
                    <tbody id="tablaJugadas">
                        <!-- Filas de jugadas se agregarán dinámicamente -->
                    </tbody>
                </table>
            </div>
            <!-- Botones para Agregar y Eliminar Jugada -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="button-group">
                    <button type="button" class="btn btn-primary" id="agregarJugada">
                        <i class="bi bi-plus-circle"></i> Agregar Jugada
                    </button>
                    <button type="button" class="btn btn-danger" id="eliminarJugada">
                        <i class="bi bi-dash-circle"></i> Eliminar Jugada
                    </button>
                </div>
                <div class="total-section">
                    Total de Jugadas: $<span id="totalJugadas">0.00</span>
                </div>
            </div>
            <!-- Botón para Generar Ticket -->
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-success btn-lg" id="generarTicket">
                    <i class="bi bi-ticket-detailed-fill"></i> Generar Ticket
                </button>
            </div>
        </form>
        <!-- Modal para Previsualizar Ticket -->
        <div class="modal fade" id="ticketModal" tabindex="-1" aria-labelledby="ticketModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content bg-dark text-white">
                    <div class="modal-header">
                        <h5 class="modal-title" id="ticketModalLabel">Previsualización del Ticket</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div id="preTicket" class="p-3">
                            <h4 class="text-center mb-3"> East New York Cricket </h4>
                            <p><strong>Fechas de Apuesta:</strong> <span id="ticketFecha"></span></p>
                            <p><strong>Tracks Seleccionados:</strong> <span id="ticketTracks"></span></p>
                            <table class="table table-dark table-bordered">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Número Apostado</th>
                                        <th>Tipo de Juego</th>
                                        <th>Straight ($)</th>
                                        <th>Box ($)</th>
                                        <th>Combo ($)</th>
                                        <th>Total ($)</th>
                                    </tr>
                                </thead>
                                <tbody id="ticketJugadas">
                                    <!-- Jugadas -->
                                </tbody>
                            </table>
                            <div class="total-section">
                                Total de Jugadas: $<span id="ticketTotal">0.00</span>
                            </div>
                            <div class="ticket-number my-3">
                                Número de Ticket: <span id="numeroTicket"></span>
                            </div>
<div class="transaction-date my-3">
        Fecha y Hora de Transacción: <span id="ticketTransaccion"></span>
    </div>                            
                            <div class="barcode text-center">
                                <div id="qrcode"></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Editar</button>
                        <button type="button" class="btn btn-primary" id="confirmarTicket">Confirmar e Imprimir</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Day.js -->
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

    <script>
  // Registrar plugins de Day.js
  dayjs.extend(window.dayjs_plugin_customParseFormat);
  dayjs.extend(window.dayjs_plugin_arraySupport);
</script>

    <!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Custom JS -->
    <script src="scripts.js"></script>
</body>
</html>
